<div class="show-page-views-container">
  <% if query.count == 0 %>
    <h2><%= "Sorry, no results could be found for this query." %></h2>
  <% else %>
    <ul class="nav nav-tabs show-page-views-tabs-container" id="myTab" role="tablist">
      <li class="nav-item show-page-views-tab-container">
        <a class="nav-link active show-page-views-tab-link" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Table</a>
      </li>
      <li class="nav-item show-page-views-tab-container">
        <a class="nav-link show-page-views-tab-link" id="chart-tab" data-toggle="tab" href="#chart" role="tab" aria-controls="chart" aria-selected="false">Chart</a>
      </li>
      <li class="nav-item show-page-views-tab-container">
        <a class="nav-link show-page-views-tab-link" id="pie-tab" data-toggle="tab" href="#pie" role="tab" aria-controls="pie" aria-selected="false">Pie-chart</a>
      </li>
      <li class="nav-item show-page-views-tab-container">
        <a class="nav-link show-page-views-tab-link" id="map-tab" data-toggle="tab" href="#map-container" role="tab" aria-controls="map-container" aria-selected="false">Map</a>
      </li>
    </ul>
    <div class="tab-content show-page-views-tab-content-container" id="myTabContent">

      <div class="tab-pane show active show-page-views-tab-pane" id="home" role="tabpanel" aria-labelledby="home-tab">
        <div class="show-page-table-wrapper">
          <div class="show-page-table-container">
            <table class='show-page-table'>
              <thead class='show-page-table-header-section'>
                <tr class='show-page-table-row'>
                  <% query[0].keys.each do |k| %>
                    <th class='show-page-table-header'><%= k.gsub("_", " ").capitalize %></th>
                  <% end %>
                </tr>
              </thead>

              <tbody class='show-page-table-body-section'>
                <% query.each do |order| %>
                <tr class='show-page-table-row'>
                  <% order.keys.each do |k| %>
                    <td class='show-page-table-data-cell'><%= order[k] %></td>
                  <% end %>
                </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>


      <div class="tab-pane show-page-views-tab-pane" id="chart" role="tabpanel" aria-labelledby="chart-tab" style="margin-top: 10px;">
        <ul class="nav nav-tabs show-page-views-tabs-container" id="myChartTab" role="tablist">
          <li class="nav-item show-page-views-tab-container">
            <a class="nav-link active show-page-views-tab-link" id="line-chart-tab" data-toggle="tab" href="#line-chart" role="tab" aria-controls="line-chart" aria-selected="true">Line Chart by something</a>
          </li>
          <li class="nav-item show-page-views-tab-container">
            <a class="nav-link show-page-views-tab-link" id="line2-chart-tab" data-toggle="tab" href="#line2-chart" role="tab" aria-controls="line2-chart" aria-selected="false">Line Chart by something</a>
          </li> 
          <li class="nav-item show-page-views-tab-container">
            <a class="nav-link show-page-views-tab-link" id="line3-chart-tab" data-toggle="tab" href="#line3-chart" role="tab" aria-controls="line3-chart" aria-selected="false">Line Chart by something</a>
          </li>
        </ul>
        <div class="tab-content show-page-views-tab-content-container" id="myChartTabContent">
          <div class="tab-pane active show show-page-views-tab-pane" id="line-chart" role="tabpanel" aria-labelledby="line-chart-tab">
            <h4>introduction</h4>
            <%= line_chart chart.group_by_day(:order_created_at).count, xtitle: "Time", ytitle: "Number of Order", colors: ["#b00", "#666"], stacked: true , discrete: true, legend: false%>
            <h2>Summary</h2>
            <p>The chart shows changes of your orders day by day.</p>
            <br>
          </div> 
            
          <div class="tab-pane show-page-views-tab-pane" id="line2-chart" role="tabpanel" aria-labelledby="line2-chart-tab">
            <h4>introduction:</h4>
            <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Molestiae soluta 
            eveniet unde blanditiis qui, voluptate maxime animi iure quo praesentium consequuntur 
            consequatur, id, officiis perferendis facilis molestias modi deleniti cumque!</p>
            <%= line_chart chart.group_by_day(:order_created_at).count, xtitle: "Time", ytitle: "Number of Order", colors: ["#b00", "#666"], discrete: true, legend: false%>
            <h2>Summary</h2>
            <p>The Column chart indicates that......</p> 
          </div>
          <div class="tab-pane show-page-views-tab-pane" id="line3-chart" role="tabpanel" aria-labelledby="line3-chart-tab">
            <h4 style="margin-top:5px;">introduction:</h4>
            <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Molestiae soluta 
            eveniet unde blanditiis qui, voluptate maxime animi iure quo praesentium consequuntur 
            consequatur, id, officiis perferendis facilis molestias modi deleniti cumque!</p>
            <%= line_chart chart.group_by_day(:order_created_at).count, xtitle: "Time", ytitle: "Number of Order", colors: ["#b00", "#666"],discrete: true, legend: false%>
            <h2>Summary</h2>
            <p>The bar chart indicates that......</p>
          </div> 
        </div> 
      </div>

      <div class="tab-pane show-page-views-tab-pane" id="pie" role="tabpanel" aria-labelledby="pie-tab">
        <!-- Don't touch this please, map projections are made for 960x500 aspect ratio -->
        <h4>Prices for each item</h4>
        <%= pie_chart chart.group(:lineitem_price).count %>
        <h2>Summary</h2>
        <p>The Pie chart indicates that......</p>  

      </div>

      <div class="tab-pane show-page-views-tab-pane" id="map-container" role="tabpanel" aria-labelledby="map-tab">
        <div id="query-json-data" class="display-none">
          <p><%= query.to_json %></p>
        </div>
        <!-- Don't touch this please, map projections are made for 960x500 aspect ratio -->

        <svg width="960" height="500" id="map"></svg>

      </div>
    </div>
  <% end %>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js" integrity="sha512-4UKI/XKm3xrvJ6pZS5oTRvIQGIzZFoXR71rRBb1y2N+PbwAsKa5tPl2J6WvbEvwN3TxQCm8hMzsl/pO+82iRlg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.6.0/d3.min.js" integrity="sha512-Gdjw6rdB8Tefa1RazvbG8hecjW7qSjnmcRnPPj40lnNnsX5Ci9pijAciBieg9XcQIFm1w/PICAzzsE6POaDyiw==" crossorigin="anonymous"></script>

<script>


  const svg = d3.select('#map');

  const width = +svg.attr('width');
  const height = +svg.attr('height');

  const projection = d3.geoNaturalEarth1();
  const pathGenerator = d3.geoPath().projection(projection);

  const g = svg.append('g');

  svg.call(d3.zoom().on('zoom', () => {
    g.attr('transform', d3.event.transform);
  }));

  Promise.all([
    // d3.tsv('https://unpkg.com/world-atlas@1.1.4/world/50m.tsv'),
    JSON.parse(document.querySelector("#query-json-data").innerText), //this is json but is being referred to as tsvData here for now.
    d3.json('https://unpkg.com/world-atlas@1.1.4/world/50m.json')
  ]).then(([tsvData, topoJSONdata]) => {
    console.log(tsvData); //checking it has been parsed correctly

    const rowById = tsvData.reduce((accumulator, d) => {
      //accumulator[d.iso_n3] = d; // Alex's original code
      accumulator[d.billing_country] = d;
      return accumulator;
    }, {});

    const countryIsos = {826:"UK", 840:"US", 124:"Canada", 250:"France", 276:"Germany", 380:"Italy", 724:"Spain", 356:"India", 710:"South Africa"};
    // const countryName = {};
    // tsvData.forEach(d => {
    //   countryName[d.iso_n3] = d.name;
    // });

    const countries = topojson.feature(topoJSONdata, topoJSONdata.objects.countries);
    console.log(countries)
    countries.features.forEach(d => {
      // console.log(d.name);
      Object.assign(d.properties, rowById[countryIsos[d.id]]);
    });

    const colorScale = d3.scaleOrdinal();

    // const colorValue = d => d.properties.economy;
    const colorValue = d => d.properties.subtotal;

    // Get rid of duplicate category entries
    // Sort category entry values
    colorScale
      .domain(countries.features.map(colorValue))
      .domain(colorScale.domain().sort().reverse())
      // .range(d3.schemeSpectral[colorScale.domain().length]);
      .range(["#D1D5DB", "#9CA3AF", "#6B7280", "#4B5563", "#374151", "#1F2937", "#111827"]);

      // "#F9FAFB", "#F3F4F6" , "#E5E7EB" ,
    g.selectAll('path').data(countries.features)
      .enter().append('path')
        .attr('class', 'country')
        .attr('d', pathGenerator)
        .attr('fill', d => colorScale(colorValue(d)))
      .append('title')
        .text(d => d.properties.billing_country + ': ' + colorValue(d));
  });

</script>

